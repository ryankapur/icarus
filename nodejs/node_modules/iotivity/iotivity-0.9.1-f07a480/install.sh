#!/bin/sh

# Default prefix is /usr
if test "x${PREFIX}x" = "xx"; then
	PREFIX="/usr"
fi

# Install the first platform/arch/configuration we find
PLATFORM="$(ls out | head -n 1)"

if test "${PLATFORM}" = "darwin"; then
  ARCH=x86_64
else
  ARCH="$(ls out/${PLATFORM} | head -n 1)"
fi

CONFIGURATION="$(ls out/${PLATFORM}/${ARCH} | grep -E "release|debug" | head -n 1)"

LIBDIR="$( echo "${DESTDIR}/${PREFIX}/lib" | sed 's@//*@/@g' )"
INCLUDEDIR="$( echo "${DESTDIR}/${PREFIX}/include" | sed 's@//*@/@g' )"

OCTBSTACK_INCLUDEDIR=iotivity/resource/csdk/stack/include

set -x

mkdir -p "${LIBDIR}" || exit 1
if test "${PLATFORM}" = "darwin"; then
  cp out/${PLATFORM}/${ARCH}/${CONFIGURATION}/*.a ${LIBDIR} || exit 1
else
  cp out/${PLATFORM}/${ARCH}/${CONFIGURATION}/liboctbstack.so ${LIBDIR} || exit 1
fi

mkdir -p "${INCLUDEDIR}/iotivity/resource/csdk/stack" || exit 1
cp -a resource/csdk/stack/include "${INCLUDEDIR}/${OCTBSTACK_INCLUDEDIR}" || exit 1

mkdir -p "${LIBDIR}/pkgconfig"
cat octbstack.pc.in | \
	sed \
		-e "s!@PREFIX@!${PREFIX}!g" \
		-e "s!@LIBDIR@!${LIBDIR}!g" \
		-e "s!@INCLUDEDIR@!${INCLUDEDIR}!g" \
		-e "s!@OCTBSTACK_INCLUDEDIR@!${OCTBSTACK_INCLUDEDIR}!g" \
	> "${LIBDIR}/pkgconfig/octbstack.pc"

